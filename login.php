<?php 
session_start();
//定义个常量，用来授权调用includes里面的文件
define('IN_TG',true);
//定义个常量，用来指定本页的内容
define('SCRIPT','login');
//引入公共文件
require dirname(__FILE__).'/includes/common.inc.php';
//登录状态

//开始处理登录状态
if ($_GET['action'] == 'login') {
    //为了防止恶意注册，跨站攻击
    _check_code($_POST['code'],$_SESSION['code']);
    //引入验证文件
    include ROOT_PATH.'includes/login.func.php';
    //接受数据
    $_clean = array();
    $_clean['username'] = $_POST['username'];
    $_clean['password'] = _check_password($_POST['password'],6);
    $_clean['time'] = _check_time($_POST['time']);
    //到数据库去验证
    if (!!$_rows = _fetch_array("SELECT username,uniqid FROM user WHERE username='{$_clean['username']}' AND passwords='{$_clean['password']}'  LIMIT 1")) {
        _close();
        _session_destroy();
        _setcookies($_rows['username'],$_rows['uniqid'],$_clean['time']);
        _location(null,'index.php');
    } else {
        _close();
        _session_destroy();
        _location('用户名密码不正确或者该账户未被激活！','login.php');
    }
}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=gbk" />
<title>登录</title>
<link rel="shortcut icon" href="sources/weibo.png" />
<link rel="stylesheet" type="text/css" href="styles/basic.css" />
<link rel="stylesheet" type="text/css" href="styles/login.css" />
<script type="text/javascript" src="scripts/code.js"></script>
<script type="text/javascript" src="scripts/login.js"></script>
</head>
<body>
<div id="login">
	<h2>登录</h2>
	<form method="post" name="login" action="login.php?action=login">
		<dl>
			<dt></dt>
			<dd>用 户 名：<input type="text" name="username" class="text" /></dd>
			<dd>密　　码：<input type="password" name="password" class="text" /></dd>
			<dd>保　　留：<input type="radio" name="time" value="0" checked="checked" /> 不保留 <input type="radio" name="time" value="1" /> 一天 <input type="radio" name="time" value="2" /> 一周 <input type="radio" name="time" value="3" /> 一月</dd>
			<dd>验 证 码：<input type="text" name="code" class="text code"  /> <img src="code.php" id="code" /></dd>
			<dd><input type="submit" value="登录" class="button" /> <input type="button" value="注册" id="location" class="button location" onclick="javascrtpt:window.location.href='register.php'"/></dd>
		</dl>
	</form>
</div>
</body>
</html>

